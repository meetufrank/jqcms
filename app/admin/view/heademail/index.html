{include file="common/head"/}
<style type="text/css">
    .select{
       position: relative;
    margin: 0 10px 0 10px;
    height: 38px;
    min-width: 120px;
    max-width: 200px;
    color: #888;
    border: 1px solid #e6e6e6; 
    }
    
</style>
<div class="admin-main layui-anim layui-anim-upbit">
    <fieldset class="layui-elem-field layui-field-title">
        <legend>{:lang('Head')}{:lang('Letter')}{:lang('list')}</legend>
    </fieldset>
    <div class="demoTable">
        <div class="layui-inline">
            <input class="layui-input" name="key" id="key" placeholder="{:lang('pleaseEnter')}{:lang('Letter id')}">
        </div>
       <div class="layui-inline " >
            <select id="form_type" name="type" class="select" >
                <option   value="0">选择信件类型</option>
                <option   value="1">咨询</option>
                <option  value="2">求助</option>
                <option  value="3">举报</option>
            </select> 
        </div>
        {if condition="session('grouptype') eq 1"}
        <div class="layui-inline " >
            <select id="form_header" name="header" class="select" >
                <option   value="0">选择首长</option>
                {foreach name="bmlist" item="bl"}
                <option   value="{$bl.group_id}">{$bl.title}</option>
                {/foreach}
                
            </select> 
        </div>
        
        <div class="layui-inline " >
            <select id="form_open" name="is_open" class="select" >
                <option   value="0">选择审核状态</option>
                <option   value="1">禁用</option>
                <option  value="2">启用</option>
  
            </select> 
        </div>
        {/if}
        <button class="layui-btn" id="search" data-type="reload">{:lang('search')}</button>
        <a href="{:url('index',['catid'=>input('catid')])}" class="layui-btn">{:lang('display all')}</a>
        {if condition="session('grouptype') eq 1"} 
        <button type="button" class="layui-btn layui-btn-danger" id="delAll">{:lang('batch deletion')}</button>
        <a href="{:url('recindex',array('catid'=>input('catid')))}" class="layui-btn layui-btn-danger" style="float:right;margin-right: 15px;">{:lang('recycle bin')}</a>
        <a href="{:url('add',array('catid'=>input('catid')))}" class="layui-btn" style="float:right;margin-right: 15px;">{:lang('add')}</a>
        {/if}
        <div style="clear: both;"></div>
    </div>
    <table class="layui-table" id="list" lay-filter="list"></table>
</div>
{include file="common/foot"/}
<script type="text/html" id="is_open">
    <input type="checkbox" name="is_open" value="{{d.id}}" lay-skin="switch" lay-text="{:lang('normal')}|{:lang('disabled')}" lay-filter="is_open" {{ d.is_open == 1 ? 'checked' : '' }}>
</script>
<script type="text/html" id="order">
    <input name="{{d.id}}" data-id="{{d.id}}" class="list_order layui-input" value=" {{d.listorder}}" size="10"/>
</script>
<script type="text/html" id="title">
    <span style="{{d.title_style}}">{{d.name}}</span>
    {{# if(d.thumb){ }}<img src="__ADMIN__/images/image.gif" onmouseover="layer.tips('<img src=__PUBLIC__/{{d.thumb}}>',this,{tips: [1, '#fff']});" onmouseout="layer.closeAll();">{{# } }}
</script>
<script type="text/html" id="action">
    <a href="{:url('Heademail/replymess')}?id={{d.id}}" class="layui-btn layui-btn-primary layui-btn-xs  ">{:lang('View')}</a>
    {if condition="session('grouptype') eq 1"} 
    <a href="{:url('Reply/index')}?id={{d.id}}" class="layui-btn layui-btn-normal layui-btn-xs  ">{:lang('Management')}</a>
    <a href="{:url('edit')}?id={{d.id}}&catid={{d.catid}}" class="layui-btn layui-btn-xs">{:lang('edit')}</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">{:lang('del')}</a>
    {/if}
</script>
<script type="text/html" id="is_reply">
    {{ d.is_reply == 1 ? '<span style="color:gray;">已回复</span>'+d.is_with : '<span style="color:red;">未回复</span>'+d.is_with }}
</script>
<script type="text/html" id="is_public">
   {{ d.is_public == 1 ? '公开' : '不公开' }}
</script>
<script>
    layui.use('table', function() {
        var table = layui.table, $ = layui.jquery,form = layui.form;
        {if condition="session('grouptype') eq 1"}
        var tableIn = table.render({
            id: 'content',
            elem: '#list',
            url: '{:url("index")}',
            where:{catid:'{:input("catid")}'},
            method: 'post',
            page: true,
            cols: [[
               {type: "checkbox", fixed: true},
                {field: 'id', title: '{:lang("id")}', width: 60, fixed: true},
                
                { width: 200,align: 'center', toolbar: '#action',title:'{:lang("operating")}'},
               
                {field: 'is_open', align: 'center',title: '{:lang("Whether to enable")}', width: 80,toolbar: '#is_open'},
                 {field: 'name', title: '{:lang("title")}',  templet: '#title'},
                 {field: 'headername', title: '{:lang("Head")}', width: 100}, 
                {field: 'typename', title: '{:lang("Type")}', width: 60},
                
                
                {field: 'is_reply', title: '{:lang("Reply status")}',  templet: '#is_reply'},
//                {field: 'is_public', title: '{:lang("Is public")}', width: 100, templet: '#is_public'},
                
//                {field: 'hits',  title: '{:lang("hit")}', width: 80},
                {field: 'createtime', title: '{:lang("add")}{:lang("time")}'},
                {field: 'listorder', align: 'center', title: '{:lang("order")}', width: 80, templet: '#order'}
               
                
            ]],
            limit: 10
        });
        {else/}
        var tableIn = table.render({
            id: 'content',
            elem: '#list',
            url: '{:url("index")}',
            where:{catid:'{:input("catid")}'},
            method: 'post',
            page: true,
            cols: [[
                {type: "checkbox", fixed: true},
                {field: 'id', title: '{:lang("id")}', width: 60, fixed: true},
                {width: 80, align: 'center', toolbar: '#action',title:'{:lang("operating")}'},
                {field: 'name', title: '{:lang("title")}', width: 200, templet: '#title'},
//                {field: 'headername', title: '{:lang("Head")}', width: 120}, 
                {field: 'typename', title: '{:lang("Type")}', width: 60},
                
                
                {field: 'is_reply', title: '{:lang("Reply status")}', width: 160, templet: '#is_reply'},
//                {field: 'is_public', title: '{:lang("Is public")}', width: 120, templet: '#is_public'},
                
//                {field: 'hits',  title: '{:lang("hit")}', width: 80},
                {field: 'createtime', title: '{:lang("add")}{:lang("time")}', width: 180}
               
                
            ]],
            limit: 10
        });
        {/if}
        form.on('switch(is_open)', function(obj){
            loading =layer.load(1, {shade: [0.1,'#fff']});
            var id = this.value;
            var is_open = obj.elem.checked===true?1:0;
            $.post('{:url("usersState")}',{'id':id,'is_open':is_open},function (res) {
                layer.close(loading);
                if (res.status==1) {
                    tableIn.reload();
                }else{
                    layer.msg(res.msg,{time:1000,icon:2});
                    return false;
                }
            })
        });
        //搜索
        $('#search').on('click', function () {
            var key = $('#key').val();
            var type = $('#form_type').val();
            var header = $('#form_header').val();
            var is_open = $('#form_open').val();
//            if ($.trim(key) === '') {
//                layer.msg('{:lang("pleaseEnter")}{:lang("keywords")}！', {icon: 0});
//                return;
//            }
            tableIn.reload({
                where: {key: key,type: type,header:header,is_open:is_open,catid:'{:input("catid")}'}
            });
        });
        $('body').on('blur','.list_order',function() {
            var id = $(this).attr('data-id');
            var listorder = $(this).val();
            var loading = layer.load(1, {shade: [0.1, '#fff']});
            $.post('{:url("listorder")}',{id:id,listorder:listorder,catid:'{:input("catid")}'},function(res){
                layer.close(loading);
                if(res.code === 1){
                    layer.msg(res.msg, {time: 1000, icon: 1}, function () {
                        location.href = res.url;
                    });
                }else{
                    layer.msg(res.msg,{time:1000,icon:2});
                }
            })
        });
        table.on('tool(list)', function(obj) {
            var data = obj.data;
            if(obj.event === 'del'){
                layer.confirm('{:lang("Are you sure you want to delete it")}', function(index){
                    var loading = layer.load(1, {shade: [0.1, '#fff']});
                    $.post("{:url('listDel')}",{id:data.id},function(res){
                        layer.close(loading);
                        if(res.code===1){
                            layer.msg(res.msg,{time:1000,icon:1});
                            tableIn.reload({where:{catid:'{:input("catid")}'}});
                        }else{
                            layer.msg('{:lang("operation failed")}',{time:1000,icon:2});
                        }
                    });
                    layer.close(index);
                });
            }
        });
        $('#delAll').click(function(){
            layer.confirm('{:lang("Are you sure you want to delete the selected content")}', {icon: 3}, function(index) {
                layer.close(index);
                var checkStatus = table.checkStatus('content'); //content即为参数id设定的值
                var ids = [];
                $(checkStatus.data).each(function (i, o) {
                    ids.push(o.id);
                });
                var loading = layer.load(1, {shade: [0.1, '#fff']});
                $.post("{:url('delAll')}", {ids: ids,catid:'{:input("catid")}'}, function (data) {
                    layer.close(loading);
                    if (data.code === 1) {
                        layer.msg(data.msg, {time: 1000, icon: 1});
                        tableIn.reload({where:{catid:'{:input("catid")}'}});
                    } else {
                        layer.msg(data.msg, {time: 1000, icon: 2});
                    }
                });
            });
        })
    });
</script>